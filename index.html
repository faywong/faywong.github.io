<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.css.network/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog of faywong, android, lisp, clojure" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="blog of faywong, faywong, 王飞">
<meta property="og:type" content="website">
<meta property="og:title" content="blog of faywong">
<meta property="og:url" content="http://faywong.github.io/index.html">
<meta property="og:site_name" content="blog of faywong">
<meta property="og:description" content="blog of faywong, faywong, 王飞">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="blog of faywong">
<meta name="twitter:description" content="blog of faywong, faywong, 王飞">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://faywong.github.io/"/>

  <title> blog of faywong </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">blog of faywong</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">love coding, love life</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/09/2017-5-9-01/" itemprop="url">
                  android 代码风格指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-05-09T15:38:56+08:00" content="2017-05-09">
              2017-05-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/05/09/2017-5-9-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/09/2017-5-9-01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>本文档简述了推荐的 android 平台开发代码风格指南</p>
<h3 id="源代码文件"><a href="#源代码文件" class="headerlink" title="源代码文件"></a>源代码文件</h3><h4 id="文件命名"><a href="#文件命名" class="headerlink" title="文件命名"></a>文件命名</h4><p>以本文件中最顶级class名加上.java后缀命名，且大小写敏感</p>
<h4 id="文件编码"><a href="#文件编码" class="headerlink" title="文件编码"></a>文件编码</h4><p>UTF-8</p>
<h4 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h4><h4 id="空白字符"><a href="#空白字符" class="headerlink" title="空白字符"></a>空白字符</h4><p>只允许ascii水平空白符(0x20)</p>
<h4 id="文件组织"><a href="#文件组织" class="headerlink" title="文件组织"></a>文件组织</h4><p>一般，一份源代码文件按照如下结构组织：</p>
<ul>
<li>授权、版权信息，如果有</li>
<li>包声明</li>
<li>导入声明</li>
<li>只包含一个顶级类</li>
</ul>
<p>并以一个空白行分隔以上每部分</p>
<ol>
<li><p>包声明<br>包声明不要进行行截断(见段4.5)，每行最多100列的限制不会施加于包声明</p>
</li>
<li><p>导入声明<br> 导入声明不要进行行截断（见段4.5），每行最多100列的限制不会施加于导入声明<br> 导入声明按以下规则分组：</p>
<p> 所有static导入为一组</p>
<p> 第三方的，按照顶级包的字母序排列，例如：android, com, junit, org, sun<br> java， javax打头的</p>
<p> 组内按照字母序排序<br> 不要使用通配符式导入，而是使用完全限定名称的类<br> 推荐：<code>import foo.Bar;</code>（优点是显式指定了特定的类）<br> 不推荐：<code>import foo.*;</code>（优点是少写import声明，但是可读性差，且给维护者带来了代价）</p>
</li>
<li><p>类声明</p>
<ul>
<li>每源代码有且仅有一个顶级类</li>
<li>成员函数的排列顺序  <br><br>一般应该按照逻辑集中的规则来排列（例如操作同一数据的方法尽量放在一起），而不要是新近添加的方法总是放在最后</li>
<li>重载的多个函数应该连续排列</li>
</ul>
</li>
</ol>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p>术语：块级结构指：类、方法、构造方法体（若数组以语句块的形式初始化，也视为块级结构）</p>
<ol>
<li><p>花括号  <br><br> 花括号应该与if, else, for, do, while语句一起使用，即便其内容为空或只包含单行语句</p>
</li>
<li><p>非空语句块采用K&amp;R风格  <br><br>  对于非空语句块，花括号遵循K&amp;R风格<br></p>
<ul>
<li>左括号前不换行</li>
<li>左括号后换行</li>
<li>右括号前换行</li>
<li>如果右括号结束一个语句块或者函数体、构造函数体或者有命名的类体，则需要换行。但当右括号后面接else或者逗号时，不应该换行, 例如：</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> MyClass() &#123;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (condition()) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        something();</div><div class="line">      &#125; <span class="keyword">catch</span> (ProblemException e) &#123;</div><div class="line">        recover();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ol>
<li>空白块级结构使用场景  <br><br>方法体为空，或空的构造方法(一个空的语句块，可以在左花括号之后直接接右花括号，中间不需要空格或换行，使代码更简洁),例如：</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doNothing</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyConstruct</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EmptyConstruct</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>块级缩进  <br><br>4个空白字符（同时适用于代码和注释）</p>
</li>
<li><p>一条语句占一行</p>
</li>
<li><p>列数限制  <br><br>超出100列长度的行应该进行断行（见下一段）  <br><br>例外：  <br></p>
<ul>
<li>没法遵循以上限制，比如JavaDoc中很长的URL，或一个很长的<a href="http://www.gwtproject.org/doc/latest/DevGuideCodingBasicsJSNI.html" target="_blank" rel="external">JSNI</a>方法引用</li>
<li>包声明，导入声明</li>
<li>可以被直接拷贝粘贴到shell中的命令</li>
</ul>
</li>
<li><p>断行  <br><br>术语说明：当一行代码按照其他规范都合法，只是为了避免超出行长度限制而换行时，称为长行断行</p>
<ul>
<li>在何处进行断行  <br><br> 一个原则：尽可能选择在更高的句法级别上进断行，且：<pre><code>1. 若遇到非赋值操作符，则在该符号前截断。这条规则同样适用于点操作符的.，类型组合符（&lt;T extends Foo &amp; Bar&gt;），catch块中的管道线（catch (FooException | BarException e)）
2. 若遇到赋值操作符，则在该符号后截断。这条规则同样适用于类赋值操作符（foreach 语句中的:），例如：
</code></pre></li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">IAccessibilityServiceConnection connection =</div><div class="line">    AccessibilityInteractionClient.getInstance().getConnection(mConnectionId);</div><div class="line">IAccessibilityServiceConnection connection = AccessibilityInteractionClient</div><div class="line">        .getInstance().getConnection(mConnectionId);</div></pre></td></tr></table></figure>
<pre><code>    3. 方法名或构造方法名与跟随其后的开括号保持连续
    4. `,`紧跟它之前的符号

* 缩进后续行最低4个空白字符（建议8个空白字符）  &lt;br /&gt;
    截断后的后续行（即不包含第一行）相对原始行最低缩进4个（建议8个）空白字符，多个后续行的情形下，若他们属于同一层的句法元素，则应保持相同的缩进级别

* 空白字符
   1. 垂直空白
      单行空行在以下情况使用：
</code></pre><p>a、类成员间需要空行隔开：例如成员变量、构造函数、成员函数、内部类、静态初始化语句块（static initializers）、实例初始化语句块（instance initializers）。<strong>例外：成员变量之间的空白行不是必需的。</strong> 一般多个成员变量中间的空行，是为了对成员变量做逻辑上的分组。</p>
<p>b、在函数内部，根据代码逻辑分组的需要，设置空白行作为间隔。</p>
<p>c、类的第一个成员之前，或者最后一个成员结束之后，用空行间隔。（可选）</p>
<p>d、本文档中其他部分介绍的需要空行的情况。（例如 3.3节中的import语句）<br>单空行时使用多行空行是允许的，但是不要求也不鼓励。</p>
<pre><code>2. 水平空白
除了语法、其他规则、词语分隔、注释和javadoc外，水平的ASCII空格只在以下情况出现：
</code></pre><p>a、所有保留的关键字与紧接它之后的位于同一行的左括号之间需要用空格隔开。（例如if、for、catch）</p>
<p>b、所有保留的关键字与在它之前的右花括号之间需要空格隔开。（例如else、catch）</p>
<p>c、在左花括号之前都需要空格隔开。只有两种例外：<br>    @SomeAnnotation({a, b})<br>  String[][] x = foo;</p>
<p>d、所有的二元运算符和三元运算符的两边，都需要空格隔开。<br>e、逗号、冒号、分号和右括号之后，需要空格隔开。</p>
<p>f、// 双斜线开始一行注释时。双斜线两边都应该用空格隔开。并且可使用多个空格，但是不做强制要求。</p>
<p>g、变量声明时，变量类型和变量名之间需要用空格隔开。</p>
<p>h、初始化一个数组时，花括号之间可以用空格隔开，也可以不使用。（例如：new int[] {5, 6} 和 new int[] { 5, 6 } 都可以）</p>
<p>注意：这一原则不影响一行开始或者结束时的空格。只针对行内部字符之间的隔开。</p>
<ol>
<li>特殊结构<ol>
<li>修饰符<pre><code>若存在，类和方法的修饰符应该按照以下顺序排列：
</code></pre><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">protected</span> <span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">synchronized</span> <span class="keyword">native</span> <span class="keyword">strictfp</span></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h3 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h3><ol>
<li><p>类名<br>大写打头的驼峰风格</p>
</li>
<li><p>方法名<br>小写打头的驼峰风格<br>最好以动词，或动宾短语命名  <br><br>唯一建议使用下划线的地方是在JUnit中用于为多个测试方法进行逻辑分组，一个典型的模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">test&lt;MethodUnderTest&gt;_&lt;state&gt;</div><div class="line">testPop_emptyStack <span class="comment">// example</span></div></pre></td></tr></table></figure>
<p>缩略词当做单词对待，而不要保持全大写（比如推荐命名为getUrl, 而不是getURL）</p>
</li>
<li><p>常量名<br>所有字母大写，单词之间以下划线分割<br>例如：</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Constants</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUMBER = <span class="number">5</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ImmutableList&lt;String&gt; NAMES = ImmutableList.of(<span class="string">"Ed"</span>, <span class="string">"Ann"</span>);</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Joiner COMMA_JOINER = Joiner.on(<span class="string">','</span>);  <span class="comment">// because Joiner is immutable</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> SomeMutableType[] EMPTY_ARRAY = &#123;&#125;;</div><div class="line"><span class="keyword">enum</span> SomeEnum &#123; ENUM_CONSTANT &#125;</div><div class="line"><span class="comment">// Not constants</span></div><div class="line"><span class="keyword">static</span> String nonFinal = <span class="string">"non-final"</span>;</div><div class="line"><span class="keyword">final</span> String nonStatic = <span class="string">"non-static"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; mutableCollection = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ImmutableSet&lt;SomeMutableType&gt; mutableElements = ImmutableSet.of(mutable);</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(MyClass.getName());</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] nonEmptyArray = &#123;<span class="string">"these"</span>, <span class="string">"can"</span>, <span class="string">"change"</span>&#125;;</div></pre></td></tr></table></figure>
<ol>
<li>驼峰规则<br> 如何将英文词汇转换为符合驼峰规则的标识符</li>
</ol>
<table>
<thead>
<tr>
<th>语义</th>
<th>推荐</th>
<th>不建议</th>
</tr>
</thead>
<tbody>
<tr>
<td>“XML HTTP request”</td>
<td>XmlHttpRequest</td>
<td>XMLHTTPRequest</td>
</tr>
<tr>
<td>“new customer ID”</td>
<td>newCustomerId</td>
<td>newCustomerID</td>
</tr>
<tr>
<td>“inner stopwatch”</td>
<td>innerStopwatch</td>
<td>innerStopWatch</td>
</tr>
<tr>
<td>“supports IPv6 on iOS?”</td>
<td>supportsIpv6OnIos</td>
<td>supportsIPv6OnIOS</td>
</tr>
<tr>
<td>“YouTube importer”</td>
<td>YouTubeImporter</td>
<td>YoutubeImporter</td>
</tr>
</tbody>
</table>
<p>可接受但不推荐的情形:  <br><br>  “nonempty”和”non-empty”都是合法的英文单词, 所以checkNonempty和checkNonEmpty都可以认为正确</p>
<p>注意：请命名时一定准备一本英文词典在附近，不要出现基本的英文拼写错误，目前已经发现的案例有：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">behaviour/behavor, pool/poll, request/reqeust, <span class="keyword">continue</span>, external, prerference</div></pre></td></tr></table></figure>
<h3 id="编程实践"><a href="#编程实践" class="headerlink" title="编程实践"></a>编程实践</h3><p>尽量使用@Override(不管是扩展重写方法还是实现接口)来避免直到运行时才可以发现的错误<br><br><br>例如以下打字错误只有在运行时才能发现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oncreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而采用以下写法错误在编译时就能被发现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oncreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不要完全忽略异常，尽管这非常诱人</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="keyword">int</span> i = Integer.parseInt(response);</div><div class="line">  <span class="keyword">return</span> handleNumericResponse(i);</div><div class="line">&#125; <span class="keyword">catch</span> (NumberFormatException ok) &#123;</div><div class="line">  <span class="comment">// it's not numeric; that's fine, just continue</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> handleTextResponse(response);</div></pre></td></tr></table></figure>
<p>绝对不要这么做。也许你会认为：<br>你的代码永远不会碰到这种出错的情况，或者处理异常并不重要，<br>可类似上述忽略异常的代码将会在代码中埋下一颗地雷，说不定哪天它就会炸到某个人了。<br>你必须在代码中以某种规矩来处理所有的异常。根据情况的不同，处理的方式也会不一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">无论何时，空的catch语句都会让人感到不寒而栗。</div><div class="line">然很多情况下确实是一切正常，但至少你不得不去忧虑它。在Java中你无法逃离这种恐惧感。&quot;</div><div class="line">                                -James Gosling</div></pre></td></tr></table></figure>
<p>可接受的替代方案包括（按照推荐顺序）:</p>
<p>1) 向方法的调用者抛出异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setServerPort</span><span class="params">(String value)</span> <span class="keyword">throws</span> NumberFormatException </span>&#123;</div><div class="line">    serverPort = Integer.parseInt(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2) 根据抽象级别抛出新的异常<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setServerPort</span><span class="params">(String value)</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       serverPort = Integer.parseInt(value);</div><div class="line">   &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"Port "</span> + value + <span class="string">" is not valid."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3) 默默地处理错误并在catch {}语句块中替换为合适的值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setServerPort</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        serverPort = Integer.parseInt(value);</div><div class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">        serverPort = <span class="number">80</span>;  <span class="comment">// default port for server</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4) 捕获异常并抛出一个新的RuntimeException。这种做法比较危险：只有确信发生该错误时最合适的做法就是崩溃，才会这么做<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setServerPort</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       serverPort = Integer.parseInt(value);</div><div class="line">   &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"port "</span> + value <span class="string">" is invalid, "</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>5) 如果确信忽略异常比较合适，那就忽略吧，但必须把合理的原因注释出来<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setServerPort</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          serverPort = Integer.parseInt(value);</div><div class="line">      &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">          <span class="comment">// Method is documented to just ignore invalid user input.</span></div><div class="line">          <span class="comment">// serverPort will just be unchanged.</span></div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>例外：在测试用例中一个期望发生的异常<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    emptyStack.pop();</div><div class="line">    fail();</div><div class="line">&#125; <span class="keyword">catch</span> (NoSuchElementException expected) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>尽量不要因为想偷懒而要捕获顶级的Exception<br><br><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    someComplicatedIOFunction();        <span class="comment">// may throw IOException</span></div><div class="line">    someComplicatedParsingFunction();   <span class="comment">// may throw ParsingException</span></div><div class="line">    someComplicatedSecurityFunction();  <span class="comment">// may throw SecurityException</span></div><div class="line">                                        <span class="comment">// phew, made it all the way</span></div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;                 <span class="comment">// I'll just catch all exceptions</span></div><div class="line">    handleError();                      <span class="comment">// with one generic handler!</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不要这么做。绝大部分情况下，捕获顶级的Exception或Throwable都是不合适的，Throwable更不合适，因为它还包含了Error异常。这种捕获非常危险。<br><br>这意味着本来不必考虑的Exception（包括类似ClassCastException的RuntimeException）被卷入到应用程序级的错误处理中来。<br><br>这会让代码运行的错误变得模糊不清。这意味着，假如别人在你调用的代码中加入了新的异常，编译器将无法帮助你识别出各种不同的错误类型。<br><br>绝大部分情况下，无论如何你都不应该用同一种方式来处理各种不同类型的异常。<br></p>
<p>当你执意想这样做：<br><br>在开始之前，你应该非常仔细地考虑一下，并在注释中解释清楚为什么这么做是安全的<br></p>
<p>比捕获顶级Exception更好的方案：<br></p>
<p>分开捕获每一种异常，在一条try语句后面跟随多个catch语句块。<br><br>这样可能会有点别扭，但总比捕获所有Exception要好些。请小心别在catch语句块中重复执行大量的代码。</p>
<p>重新组织一下代码，使用多个try块，使错误处理的粒度更细一些。把IO从解析内容的代码中分离出来，根据各自的情况进行单独的错误处理。<br></p>
<p>再次抛出异常。很多时候在你这个级别根本就没必要捕获这个异常，只要让方法抛出该异常即可。<br></p>
<p>请建立一个观点：异常是你的朋友！当编译器指出你没有捕获某个异常时，请不要皱眉头。而应该微笑：编译器帮助你找到了代码中的运行时（runtime）问题。<br></p>
<p>静态成员：通过类名来限定</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Foo aFoo = ...;</div><div class="line">Foo.aStaticMethod(); <span class="comment">// good</span></div><div class="line">aFoo.aStaticMethod(); <span class="comment">// bad</span></div></pre></td></tr></table></figure>
<p>永远不要重载finalize方法，除非：<br><br><br>你需要在JNI方法中在Java对象被GC回收时释放native层资源</p>
<p>尽量限制变量的作用域</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GOOD</span></div><div class="line"><span class="keyword">if</span> (…) &#123;</div><div class="line">    <span class="keyword">double</span> d = someCalculation(…);</div><div class="line">    doSomethingWith(d);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// No use of d</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// BAD</span></div><div class="line"><span class="keyword">double</span> d = <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (…) &#123; … &#125; <span class="keyword">else</span> &#123; … &#125;</div></pre></td></tr></table></figure>
<p>为临时性/不完美代码使用TODO注释<br><br><br>TODO注释的格式为：<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// <span class="doctag">TODO:</span> &#123;your_comments_here&#125;</span></div></pre></td></tr></table></figure></p>
<p>类和方法前的概述段一般是名词或动词短语，而不要是一整句话，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BAD</span></div><div class="line">A &#123;<span class="meta">@code</span> Foo&#125; is a...</div><div class="line"><span class="comment">// BAD too</span></div><div class="line">This method returns...</div></pre></td></tr></table></figure>
<p>也不要是一个祈使句：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Save the record..</div></pre></td></tr></table></figure></p>
<p>然而需要注意的是：概述段需要想完整的一句话一样打头字母大写，添加合适的标点等等</p>
<p>正确的注释，例如android AOSP项目中类<em>MediaCodecInfo</em>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides information about a given media codec available on the device. You can</div><div class="line"> * iterate through all codecs available by querying &#123;<span class="doctag">@link</span> MediaCodecList&#125;...</div><div class="line"> */</div><div class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaCodecInfo</span> </span>&#123;</div><div class="line"> ......</div></pre></td></tr></table></figure>
<p>每个类和自建的public方法必须包含Javadoc注释<br><br><br>注释至少要包含描述该类或方法用途的语句。并且该语句应该用第三人称的动词形式来开头</p>
<p>组织方法的原则</p>
<ul>
<li>简短(对方法的代码长度并没有硬性的限制，但通常如果方法代码超过了40行，就该考虑是否可以在不损害程序结构的前提下进行分拆)</li>
<li>专注于完成单一功能</li>
<li>可重用</li>
<li>易于测试</li>
</ul>
<p><strong> 版权归 faywong 所有，转载请注明出处 </strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/wxapp_toolchain/" itemprop="url">
                  浅析微信小程序之 IDE
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-12T09:22:33+08:00" content="2017-01-12">
              2017-01-12
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/12/wxapp_toolchain/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/12/wxapp_toolchain/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我在上一篇<a href="http://www.atatech.org/articles/70296" target="_blank" rel="external">纠正对微信小程序的一个认知</a>中提到现在的微信小程序是 h5 做的，那今天下班前花十分钟浅谈下小程序 IDE 中的一些逻辑和线索，既能佐证之前的言论，又可以当做今天半天工作的总结。</p>
<h3 id="小程序-IDE-的架构"><a href="#小程序-IDE-的架构" class="headerlink" title="小程序 IDE 的架构"></a>小程序 IDE 的架构</h3><p>没什么好说的，网站上整齐地亮着 windows, mac, linux 三个平台的安装包，90% 的可能性是用的 <a href="http://nwjs.readthedocs.io/en/latest/" target="_blank" rel="external">nwjs</a>，实际用的也是 nwjs。 </p>
<h3 id="main-entry-在哪儿"><a href="#main-entry-在哪儿" class="headerlink" title="main entry 在哪儿"></a>main entry 在哪儿</h3><p>页面启动的入口在哪里呢，我们看下 network 面板：</p>
<p><img src="http://storage1.imgchr.com/CAoK1.png" alt=""></p>
<p>可见启动流程是 page-frame.html -&gt; appservice 服务下载 asdebug.js 以及其他 js，比如 appservice 的地址为：<a href="http://685122098.appservice.open.weixin.qq.com/asdebug.js" target="_blank" rel="external">http://685122098.appservice.open.weixin.qq.com/asdebug.js</a></p>
<p>那这是个在线地址吗，no, no, no, 它是个本地代理地址，由 nwjs 后端实现。其中 685122098 是一个 hash，由你的小程序 appId + name hash 生成。</p>
<p>我们看下这个代理服务器的代理规则：</p>
<p><img src="http://storage1.imgchr.com/CAv2d.png" alt=""></p>
<p><img src="http://storage1.imgchr.com/CATDx.png" alt="服务端代理规则的实现"></p>
<h3 id="梳理下重点"><a href="#梳理下重点" class="headerlink" title="梳理下重点"></a>梳理下重点</h3><p>由于 IDE 整个的代码量巨大，且大量使用了 ES2015 里边的特性 + minify 转换，可读性很差。我取其精华，梳理出一些重点逻辑。</p>
<ul>
<li>wxml2html</li>
</ul>
<p><img src="http://storage1.imgchr.com/CAXPe.png" alt=""></p>
<p>这个步骤是把本地 wxml 格式的小程序模板转为 html 格式，纳尼，原来真是 html 啊，不过这里生成的 html 是为了给 IDE 渲染用的（调试开发阶段）。同时开发调试阶段为断了你使用原始 html + Dom 操作的念想，IDE 特意禁止展示原始的 html：</p>
<p><img src="http://storage1.imgchr.com/CA7b6.png" alt=""></p>
<p>附上 wxml2html 过程的<a href="https://gist.github.com/faywong/ccf528c9d23fda97d8e60d9861ab15b2" target="_blank" rel="external">输入及输出</a>。</p>
<p>输出的 html 代码中包含了微信 js api 的 bridge 实现，前端公共 weUI 样式，以及 template -&gt; html 元素的对应。<br>记性好的老司机肯定记得我曾经说过，有些组件的实现现在是 h5，未来可以迁移至用 native 来实现，这一点体现在：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">       <span class="keyword">var</span> m = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">           <span class="keyword">return</span> &#123;</div><div class="line">               renderingMode: <span class="string">"native"</span>,</div><div class="line">               keepWhiteSpace: !<span class="number">1</span>,</div><div class="line">               parseTextContent: !<span class="number">1</span></div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       g._setGlobalOptionsGetter = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">           m = e</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       <span class="comment">// 创建元素的构造器</span></div><div class="line">                   g.create = <span class="function"><span class="keyword">function</span>(<span class="params">e, t, n, r</span>) </span>&#123;</div><div class="line">           <span class="keyword">var</span> a = m(),</div><div class="line">               s = r.renderingMode || a.renderingMode,</div><div class="line">               c = k;</div><div class="line">           <span class="string">"native"</span> === s &amp;&amp; (c = E);</div><div class="line">           <span class="keyword">var</span> d = o(e.attributes),</div><div class="line">               u = &#123;</div><div class="line">                   parseTextContent: <span class="keyword">void</span> <span class="number">0</span> !== d[<span class="string">"parse-text-content"</span>] || r.parseTextContent || a.parseTextContent,</div><div class="line">                   keepWhiteSpace: <span class="keyword">void</span> <span class="number">0</span> !== d[<span class="string">"keep-white-space"</span>] || r.keepWhiteSpace || a.keepWhiteSpace</div><div class="line">               &#125;,</div><div class="line">               h = e.content;</div><div class="line">           <span class="keyword">if</span> (<span class="string">"TEMPLATE"</span> !== e.tagName)</div><div class="line">               <span class="keyword">for</span> (h = <span class="built_in">document</span>.createDocumentFragment(); e.childNodes.length;) h.appendChild(e.childNodes[<span class="number">0</span>]);</div><div class="line">           <span class="keyword">var</span> f = !<span class="number">1</span>,</div><div class="line">               v = <span class="function"><span class="keyword">function</span>(<span class="params">e, o, r, a</span>) </span>&#123;</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">var</span> d = <span class="keyword">void</span> <span class="number">0</span>, u = <span class="number">0</span>; u &lt; o.length; u++) &#123;</div><div class="line">                       <span class="keyword">var</span> h = o[u],</div><div class="line">                           g = r.concat(e.length);</div><div class="line">                       <span class="keyword">if</span> (<span class="number">8</span> !== h.nodeType)</div><div class="line">                           <span class="keyword">if</span> (<span class="number">3</span> !== h.nodeType)</div><div class="line">                               <span class="keyword">if</span> (<span class="string">"WX-CONTENT"</span> !== h.tagName &amp;&amp; <span class="string">"SLOT"</span> !== h.tagName) &#123;</div><div class="line">                                   <span class="keyword">var</span> m = h.tagName.indexOf(<span class="string">"-"</span>) &gt;= <span class="number">0</span> &amp;&amp; <span class="string">"native"</span> !== s,</div><div class="line">                                       k = <span class="literal">null</span>;</div><div class="line">                                   m || (k = <span class="built_in">document</span>.createElement(h.tagName));</div><div class="line">                                   <span class="keyword">var</span> E = <span class="string">""</span>,</div><div class="line">                                       S = h.attributes,</div><div class="line">                                       T = [];</div><div class="line">......</div></pre></td></tr></table></figure>
<ul>
<li>wxml2js<br><img src="http://storage1.imgchr.com/CAj8H.png" alt=""></li>
</ul>
<p>在线上版本（真机环境）中运行的代码由 wxml2js 过程生成，怎么验证呢。好，接下来我们讲下小程序安装包的格式：</p>
<ul>
<li>小程序安装包的格式</li>
</ul>
<p><img src="http://storage1.imgchr.com/CAqUO.png" alt="小程序格式"><br><img src="http://storage1.imgchr.com/CAL5D.png" alt="小程序格式 html 部分"><br><img src="http://storage1.imgchr.com/CAbVK.png" alt="小程序格式 dom 部分"></p>
<p>总结下安装包的格式：紧凑型单文件形式 + html 框架/容器部分 + 从 wxml 模板转换得来的 js（动态生成 dom）</p>
<ul>
<li>项目-&gt;预览</li>
</ul>
<p>涉及到打包并上传的逻辑，夜已深，只能直抒胸臆了：</p>
<p><img src="http://storage1.imgchr.com/CA5vR.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/weixin_xiaochengxu_01/" itemprop="url">
                  纠正对微信小程序的一个认知
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-12T09:22:33+08:00" content="2017-01-12">
              2017-01-12
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/12/weixin_xiaochengxu_01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/12/weixin_xiaochengxu_01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="小程序是-native-还是-web"><a href="#小程序是-native-还是-web" class="headerlink" title="小程序是 native 还是 web"></a>小程序是 native 还是 web</h4><p>最近关于小程序的新闻和讨论甚嚣尘上，笔者周围各处都充满了溢美之词。</p>
<p>“哇，这个小程序体验好棒…”。</p>
<p>作为一个写过 hello world 的程序员，简要纠正一点小程序技术实现上的疑虑：</p>
<p>目前的微信小程序使用的是 html web 技术来实现的，而不是完全的 native，native 目测 10%不到。<br>至于性能和体验的话，我用眼睛大致测试了下，比最新的 iOS chrome 浏览器要低个 10% 以上。</p>
<p>简单的说，目前的小程序大致等于：专门适配的 html 网页 + native 标题栏/动画 + disable zoom。</p>
<p>小程序的技术实现，我引用<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/details.html?t=201715" target="_blank" rel="external">官方文档</a>中的重要部分：</p>
<blockquote>
<p>三端的脚本执行环境聚以及用于渲染非原生组件的环境是各不相同的：</p>
<p>在 iOS 上，小程序的 javascript 代码是运行在 JavaScriptCore 中，是由 WKWebView 来渲染的，环境有 iOS8、iOS9、iOS10<br>在 Android 上，小程序的 javascript 代码是通过 X5 JSCore来解析，是由 X5 基于 Mobile Chrome 37 内核来渲染的<br>在 开发工具上， 小程序的 javascript 代码是运行在 nwjs 中，是由 Chrome Webview 来渲染的</p>
</blockquote>
<h4 id="未来是否可能是-native"><a href="#未来是否可能是-native" class="headerlink" title="未来是否可能是 native"></a>未来是否可能是 native</h4><p>完全可能。从组件化、抽象化的 template DSL + 去掉陈旧的浏览器那套 DOM 操作能力来看，小程序面向开发者订立了一套实现可充分扩展的开发者界面。</p>
<p>基本组件既可以在现在使用 web 技术来实现，也可以在未来升级为使用 native 来实现。</p>
<h4 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h4><p>诚然，对于小程序这个期望提供“用完即走”体验的应用解决方案来说，技术框架永远不是影响最大的，准入审核机制、 粘性用户基数、开发者生态这些也都是重要的基础能力/资源。</p>
<p>注：转载请注明本文原始出处<a href="http://faywong.github.io/2017/01/12/weixin_xiaochengxu_01/">blog of faywong</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/19/elixir_lession_1/" itemprop="url">
                  CentOS 7 上 Elixir 开发之环境配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-19T11:52:01+08:00" content="2016-12-19">
              2016-12-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/19/elixir_lession_1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/19/elixir_lession_1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于 erlang 依赖 wxGTK 等相关基础图形库，后者是维护在 epel 仓库里，所以首先需要安装 epel 软件仓库</p>
<h3 id="添加-epel-软件仓库"><a href="#添加-epel-软件仓库" class="headerlink" title="添加 epel 软件仓库"></a>添加 epel 软件仓库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum install epel-release</div></pre></td></tr></table></figure>
<h3 id="安装需要用到的小工具"><a href="#安装需要用到的小工具" class="headerlink" title="安装需要用到的小工具"></a>安装需要用到的小工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum install unzip wget git vim</div></pre></td></tr></table></figure>
<h3 id="安装-erlang"><a href="#安装-erlang" class="headerlink" title="安装 erlang"></a>安装 erlang</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">wget http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpm</div><div class="line">sudo rpm -Uvh erlang-solutions-1.0-1.noarch.rpm</div><div class="line">yum install erlang</div></pre></td></tr></table></figure>
<h3 id="安装-elixir"><a href="#安装-elixir" class="headerlink" title="安装 elixir"></a>安装 elixir</h3><p>注意：由于版本过度，请不要从 CentOS 的中央仓库安装 elixir </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/elixir-lang/elixir.git</div><div class="line"><span class="built_in">cd</span> elixir</div><div class="line"></div><div class="line">ELIXIRLASTREVISION=$(git rev-list --tags --max-count=1)</div><div class="line"></div><div class="line">ELIXIRLASTTAG=$(git describe --tags <span class="variable">$&#123;ELIXIRLASTREVISION&#125;</span>)</div><div class="line"><span class="built_in">cd</span> -</div><div class="line">rm --force --recursive elixir/</div><div class="line">wget --quiet https://github.com/elixir-lang/elixir/releases/download/<span class="variable">$&#123;ELIXIRLASTTAG&#125;</span>/Precompiled.zip</div><div class="line">sudo rm -R /usr/lib/elixir</div><div class="line">sudo unzip Precompiled.zip <span class="_">-d</span> /usr/lib/elixir/</div><div class="line">sudo rm Precompiled.zip</div><div class="line">sudo rm /usr/bin/iex</div><div class="line">sudo rm /usr/bin/elixir</div><div class="line">sudo rm /usr/bin/elixirc</div><div class="line">sudo rm /usr/bin/mix</div><div class="line">sudo ln <span class="_">-s</span> ../lib/elixir/bin/iex /usr/bin/</div><div class="line">sudo ln <span class="_">-s</span> ../lib/elixir/bin/elixir /usr/bin/</div><div class="line">sudo ln <span class="_">-s</span> ../lib/elixir/bin/elixirc /usr/bin/</div><div class="line">sudo ln <span class="_">-s</span> ../lib/elixir/bin/mix /usr/bin/</div></pre></td></tr></table></figure>
<p>最后确认下 mix 的版本：<br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mix --version</div></pre></td></tr></table></figure></p>
<p>在笔者写作这篇文章时的输出：<br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Erlang/OTP 19 [erts-8.2] [<span class="built_in">source</span>-fbd2db2] [64-bit] [async-threads:10] [hipe] [kernel-poll:<span class="literal">false</span>]</div><div class="line"></div><div class="line">Mix 1.4.0-rc.1 (16a14c1)</div></pre></td></tr></table></figure></p>
<h3 id="安装-hex-postgresql-9-6-及-phoenix-app"><a href="#安装-hex-postgresql-9-6-及-phoenix-app" class="headerlink" title="安装 hex, postgresql-9.6 及 phoenix app"></a>安装 hex, postgresql-9.6 及 phoenix app</h3><p>postgresql 是 phoenix 默认的数据库，若需要的话，遵循如下方式安装最新的 9.6 版本：</p>
<ul>
<li><p>添加 postgresql 软件源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum localinstall https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-centos96-9.6-3.noarch.rpm</div></pre></td></tr></table></figure>
</li>
<li><p>安装 postgresql-9.6</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum install postgresql96</div></pre></td></tr></table></figure>
</li>
<li><p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">/usr/pgsql-9.6/bin/postgresql96-setup initdb</div></pre></td></tr></table></figure>
</li>
<li><p>启动数据库服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">systemctl start postgresql-9.6.service</div></pre></td></tr></table></figure>
</li>
<li><p>添加为系统自启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">systemctl <span class="built_in">enable</span> postgresql-9.6.service</div></pre></td></tr></table></figure>
</li>
<li><p>为支持 live code reload 安装下 nodejs, inotify-tools</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum install inotify-tools</div><div class="line">yum install nodejs</div></pre></td></tr></table></figure>
</li>
<li><p>安装 hex 及 phoenix app 框架</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mix local.hex</div><div class="line">mix archive.install https://github.com/phoenixframework/archives/raw/master/phoenix_new.ez</div></pre></td></tr></table></figure>
</li>
<li><p>[可选] 安装 vim elixir 语法高亮插件<br>需要 <a href="https://github.com/VundleVim/Vundle.vim" target="_blank" rel="external">Vundle</a> 支持</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">vim ~/.vimrc</div><div class="line">添加：</div><div class="line">Plugin <span class="string">'elixir-lang/vim-elixir'</span></div></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/25/android-studio-jdk7-的bug/" itemprop="url">
                  android studio + jdk7 的bug
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-25T10:32:27+08:00" content="2016-07-25">
              2016-07-25
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/25/android-studio-jdk7-的bug/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/25/android-studio-jdk7-的bug/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近换了 mac book pro，重新安装 jdk 时默认选择了 jdk 8，结果下载 android studio 2.1.2 后没法启动。显示如下 crash 信息：<br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">java.lang.reflect.InvocationTargetException</div><div class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</div><div class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">    at java.lang.reflect.Method.invoke(Method.java:606)</div><div class="line">    at com.intellij.ide.Bootstrap.main(Bootstrap.java:39)</div><div class="line">    at com.intellij.idea.Main.main(Main.java:103)</div><div class="line">Caused by: java.lang.UnsatisfiedLinkError: /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/jre/lib/lwawt/liblwawt.dylib: dlopen(/Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/jre/lib/lwawt/liblwawt.dylib, 1): Library not loaded: @rpath/libosxapp.dylib</div><div class="line">  Referenced from: /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/jre/lib/lwawt/liblwawt.dylib</div><div class="line">  Reason: image not found</div></pre></td></tr></table></figure></p>
<p>后来 google 之，找到一个简单的解决方案（rpath设置不全的原因）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/jre/lib/</div><div class="line">sudo cp -rf libosxapp.dylib lwawt/</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/2015-01-19-first/" itemprop="url">
                  android4.1上WebView页面加载成功时出现IllegalArgumentException
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T11:05:25+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/19/2015-01-19-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/19/2015-01-19-first/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>异常的堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">java.lang.IllegalArgumentException: bad parameter</div><div class="line">   at org.apache.http.client.utils.URLEncodedUtils.parse(URLEncodedUtils.java:<span class="number">139</span>)</div><div class="line">   at org.apache.http.client.utils.URLEncodedUtils.parse(URLEncodedUtils.java:<span class="number">76</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.getAxsUrlParameterValue(AccessibilityInjector.java:<span class="number">412</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.shouldInjectJavaScript(AccessibilityInjector.java:<span class="number">327</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.onPageFinished(AccessibilityInjector.java:<span class="number">286</span>)</div><div class="line">   at android.webkit.WebViewClassic.onPageFinished(WebViewClassic.java:<span class="number">4088</span>)</div><div class="line">   at android.webkit.CallbackProxy.handleMessage(CallbackProxy.java:<span class="number">332</span>)</div><div class="line">   at android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>)</div><div class="line">   at android.os.Looper.loop(Looper.java:<span class="number">137</span>)</div><div class="line">   at android.app.ActivityThread.main(ActivityThread.java:<span class="number">4829</span>)</div><div class="line">   at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">   at java.lang.reflect.Method.invoke(Method.java:<span class="number">511</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">841</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">608</span>)</div><div class="line">   at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure>
<p>相关的google code android project里边的issue中论述如下：</p>
<p>“<br>A customer of mine running 4.1.2 just informed me that the issue is still<br>present! After this issue crashes my app, I have to pop up a dialog<br>telling them to disable all accessibility services.<br>Worst user experience ever, but what else can I do.<br>……<br>Fixed in an internal build, to be released in the next major release.<br>……<br>The bug doesn’t occur here in 4.2.1 (Galaxy Nexus, JOP40D).<br>“</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/2015-01-20-second/" itemprop="url">
                  开源的崩溃统计项目Socorro
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T11:05:25+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/19/2015-01-20-second/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/19/2015-01-20-second/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由Mozilla开源的崩溃统计项目Socorro非常适合针对客户端的崩溃闪退、日志/堆栈上报，服务端进行采集、处理、分析、报告。</p>
<p>客户端的工作由类库<a href="https://wiki.mozilla.org/Breakpad" target="_blank" rel="external">Breakpad</a>完成。</p>
<p>服务端的工作由<a href="https://github.com/mozilla/socorro/" target="_blank" rel="external">Socorro</a>完成。</p>
<p>代码托管在<a href="https://github.com/mozilla/socorro" target="_blank" rel="external">github</a>.</p>
<p>看这个提交和发布的数目，迭代程度还是挺深的。</p>
<p>这样针对移动开发，就不必重复造轮子了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/2015-01-21-first/" itemprop="url">
                  通过PackageManager query应用信息时出现java.lang.RuntimeException: Package manager has died
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T11:05:25+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/19/2015-01-21-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/19/2015-01-21-first/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这属于android中最常见的TransactionTooLargeException的后果表现之一。</p>
<p>该问题较多出现在使用PackageManager查询系统的应用的信息，通过Intent来过滤匹配目标应用组件（android四大组件）时，典型堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">java.lang.RuntimeException: Package manager has died</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">78</span>)</div><div class="line"></div><div class="line">......</div><div class="line">Caused by: android.os.TransactionTooLargeException</div><div class="line">at android.os.BinderProxy.transact(Native Method)</div><div class="line">at android.content.pm.IPackageManager$Stub$Proxy.getPackageInfo(IPackageManager.java:<span class="number">1393</span>)</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">73</span>)</div><div class="line">... <span class="number">17</span> more</div><div class="line">android.os.TransactionTooLargeException</div><div class="line">at android.os.BinderProxy.transact(Native Method)</div><div class="line">at android.content.pm.IPackageManager$Stub$Proxy.getPackageInfo(IPackageManager.java:<span class="number">1393</span>)</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">73</span>)</div></pre></td></tr></table></figure>
<p>这是Java层的堆栈，原始抛出异常的地方在于文件frameworks/base/core/jni/android_util_Binder.cpp：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">case</span> FAILED_TRANSACTION:</div><div class="line"> LOGE(<span class="string">"!!! FAILED BINDER TRANSACTION !!!"</span>);</div><div class="line"> <span class="comment">// TransactionTooLargeException is a checked exception, only throw from certain methods.</span></div><div class="line"> <span class="comment">// <span class="doctag">FIXME:</span> Transaction too large is the most common reason for FAILED_TRANSACTION</span></div><div class="line"> <span class="comment">//        but it is not the only one.  The Binder driver can return BR_FAILED_REPLY</span></div><div class="line"> <span class="comment">//        for other reasons also, such as if the transaction is malformed or</span></div><div class="line"> <span class="comment">//        refers to an FD that has been closed.  We should change the driver</span></div><div class="line"> <span class="comment">//        to enable us to distinguish these cases in the future.</span></div><div class="line"> jniThrowException(env, canThrowRemoteException</div><div class="line"> ? <span class="string">"android/os/TransactionTooLargeException"</span></div><div class="line"> : <span class="string">"java/lang/RuntimeException"</span>, <span class="literal">NULL</span>);</div><div class="line"> <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>该FAILED_TRANSACTION错误码定义于：<br>/bionic/libc/kernel/common/linux/binder.h中的BR_FAILED_REPLY</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">enum</span> BinderDriverReturnProtocol &#123;</div><div class="line">BR_ERROR = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">0</span>, <span class="keyword">int</span>),</div><div class="line"></div><div class="line">BR_OK = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">1</span>),</div><div class="line"></div><div class="line">BR_TRANSACTION = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">2</span>, <span class="keyword">struct</span> binder_transaction_data),</div><div class="line">BR_REPLY = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">3</span>, <span class="keyword">struct</span> binder_transaction_data),</div><div class="line"></div><div class="line">BR_ACQUIRE_RESULT = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">4</span>, <span class="keyword">int</span>),</div><div class="line"></div><div class="line">BR_DEAD_REPLY = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">5</span>),</div><div class="line"></div><div class="line">BR_TRANSACTION_COMPLETE = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">6</span>),</div><div class="line"></div><div class="line">BR_INCREFS = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">7</span>, <span class="keyword">struct</span> binder_ptr_cookie),</div><div class="line">BR_ACQUIRE = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">8</span>, <span class="keyword">struct</span> binder_ptr_cookie),</div><div class="line">BR_RELEASE = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">9</span>, <span class="keyword">struct</span> binder_ptr_cookie),</div><div class="line">BR_DECREFS = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">10</span>, <span class="keyword">struct</span> binder_ptr_cookie),</div><div class="line"></div><div class="line">BR_ATTEMPT_ACQUIRE = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">11</span>, <span class="keyword">struct</span> binder_pri_ptr_cookie),</div><div class="line"></div><div class="line">BR_NOOP = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">12</span>),</div><div class="line"></div><div class="line">BR_SPAWN_LOOPER = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">13</span>),</div><div class="line"></div><div class="line">BR_FINISHED = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">14</span>),</div><div class="line"></div><div class="line">BR_DEAD_BINDER = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">15</span>, <span class="keyword">void</span> *),</div><div class="line"></div><div class="line">BR_CLEAR_DEATH_NOTIFICATION_DONE = <span class="number">_</span>IOR_BAD(<span class="string">'r'</span>, <span class="number">16</span>, <span class="keyword">void</span> *),</div><div class="line"></div><div class="line">BR_FAILED_REPLY = <span class="number">_</span>IO(<span class="string">'r'</span>, <span class="number">17</span>),</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其原因总结如下，首先Android系统对于Binder IPC每进程的事务buffer上限是1M（为所有Binder事务共享，且不区分目标系统的ram配置等因素），在通过PackageManager中获取系统内应用时，比如应用的Icon是个bitmap，且不同应用所制作Icon的品质（像素数）上差异很大。会占用大量内存导致Binder事务内存超过上限。</p>
<p>Binder事务buffer的尺寸定义在ProcessState.cpp：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_VM_SIZE((1 * 1024 * 1024) - (4096 * 2))</span></div><div class="line">......</div><div class="line">ProcessState::ProcessState(): mDriverFD(open_driver()), mVMStart(MAP_FAILED), mManagesContexts(<span class="literal">false</span>), mBinderContextCheckFunc(<span class="literal">NULL</span>), mBinderContextUserData(<span class="literal">NULL</span>), mThreadPoolStarted(<span class="literal">false</span>), mThreadPoolSeq(<span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// XXX Ideally, there should be a specific define for whether we</span></div><div class="line">        <span class="comment">// have mmap (or whether we could possibly have the kernel module</span></div><div class="line">        <span class="comment">// availabla).</span></div><div class="line">        <span class="meta">#</span></div><div class="line">        <span class="meta-keyword">if</span> !defined(HAVE_WIN32_IPC)</div><div class="line">            <span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></div><div class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (mVMStart == MAP_FAILED) &#123;</div><div class="line">            <span class="comment">// *sigh*</span></div><div class="line">            LOGE(<span class="string">"Using /dev/binder failed: unable to mmap transaction memory.\n"</span>);</div><div class="line">            close(mDriverFD);</div><div class="line">            mDriverFD = <span class="number">-1</span>;</div><div class="line">        &#125;<span class="meta">#</span></div><div class="line">        <span class="meta-keyword">else</span></div><div class="line">            mDriverFD = <span class="number">-1</span>;<span class="meta">#</span></div><div class="line">        <span class="meta-keyword">endif</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    LOG_ALWAYS_FATAL_IF(mDriverFD &lt; <span class="number">0</span>, <span class="string">"Binder driver could not be opened.  Terminating."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>App icon对应的数据模型如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppInfo</span> </span>&#123;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">private</span> BitmapDrawable icon</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该问题是android系统的限制，只能通过上层来捕获该异常来绕过。当然也不仅限于PackageManager，其他系统服务，应用间的Binder调用也可以带来这一问题。</p>
<p>最后的最后，由于在c++向java层抛出这个异常的场景有多种（见上边c++代码中“FAILED_TRANSACTION”处的注释），所以当你收到了TransactionTooLargeException的时候，不意味着真正的Transaction is Too Large。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/2015-02-06-first/" itemprop="url">
                  Android 4.2.2上WebView.loadUrl带来软键盘自动收起的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T11:05:25+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/19/2015-02-06-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/19/2015-02-06-first/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天由测试同学反映两款手机（红米，三星GS4，均搭载Android 4.2.2）存在WebApp中收到回调后软键盘自动收起。</p>
<p>经过一段时间的研究，发现在Android 4.2.2上WebView.loadUrl()被调用后WebView会认为新的一个页面即将打开，而将软键盘收起。</p>
<p>android填坑之旅还要继续……</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/2015-01-23-first/" itemprop="url">
                  应用压入后台时由WebView带来的耗电问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T11:05:25+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/19/2015-01-23-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/19/2015-01-23-first/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近遇到一个应用打开WebApp后，将应用压入后台，出现比较耗电的问题。集合众多同学的智慧之后定位到原因：</p>
<p>在WebKit的内核中会引用从各个平台(android, linux pc, mac)注入的自己的服务比如：</p>
<ul>
<li>DeviceOrientationService</li>
<li>DeviceMotionService</li>
</ul>
<p>而这两个Service在android平台上的实现皆通过注册侦听器到SensorManager来获知来自于加速度器，磁力计的方位、手机姿势数据。</p>
<p>Sensor的使用是极其浪费电力的一件事情，所以就出现了上文所述问题。</p>
<p>解决方法：</p>
<p>1) 在Activity的onPause(), onResume()时调用WebView.onPause(), WebView.onResume()以尽量将JS执行线程以及其他WebCore中的线程给停住</p>
<p>2) 在onStop()时将WebView中当前load的url记住，然后让WebView.loadUrl(“about:blank”)，在onStart()时WebView.loadUrl({your_previous_url})</p>
<p>更新：<br>[2015/11]在最近的工作中还发现一种前端页面带来的耗电问题：当页面加载一些gif或者通过其他方式创建的动画效果，当webview变得不可见后这些动画如果没有被显式关掉，就会导致很严重的耗电问题。同时在桌面浏览器里边我也注意到页面里边持续运行的动画也会导致内存占用增大。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="faywong" />
          <p class="site-author-name" itemprop="name">faywong</p>
          <p class="site-description motion-element" itemprop="description">blog of faywong, faywong, 王飞</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">faywong</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="http://cdn.css.net/libs/jquery/1.8.0/jquery-1.8.0.min.js"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"faywong"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
