<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="blog of faywong, faywong">
<meta name="keywords" content="android, clojure, software development, web, javascript, backend">
<meta property="og:type" content="website">
<meta property="og:title" content="blog of faywong">
<meta property="og:url" content="http://faywong.github.io/index.html">
<meta property="og:site_name" content="blog of faywong">
<meta property="og:description" content="blog of faywong, faywong">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="blog of faywong">
<meta name="twitter:description" content="blog of faywong, faywong">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://faywong.github.io/"/>





  <title>blog of faywong</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">blog of faywong</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">love coding, love life</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/06/2017-06-3-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/06/2017-06-3-01/" itemprop="url">美化终端里的生活</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-06T11:52:49+08:00">
                2017-06-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/06/2017-06-3-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/06/2017-06-3-01/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="我的热爱"><a href="#我的热爱" class="headerlink" title="我的热爱"></a>我的热爱</h3><p>从 2007 年接触 Linux 开始，便一直习惯在终端里做事情。最开始是简单的 c/c++ 编程，后边遇到了 vim 便一发不可收拾。</p>
<p>Linux 世界里有很多神器——LaTeX, vim, emacs，个中奇技淫巧可能一辈子都难以穷尽，但每个爱他们的人都至爱着他们可能习惯了上十年的若干特性。我主要用着 bash、vim、ctags/cscope 这几件。</p>
<p>zsh 敢情也是极好的 shell，只是我习惯使然，也是惰性使然，不会再去了解它了。</p>
<p>vim 有两个系列，主要是 NeoVim 和 经典 vim，前者是由于经典 vim 在新特性的开发上太慢而分裂出来的版本，在异步化编程的支持、buffer 管理方面有很多新特性，给用户的感知就是做事能多任务，效率会更高，明显地降低前端界面的卡顿感。比如自动补全这种场景需要 clang 一边咀嚼源代码生成 vst 信息一边给 vim 前端提供数据就非常依赖这个特性； 有了异步 job control neovim 里生成 tags 也变得更优雅而安静。最近 vim 8.x 也发布了，朝着 NeoVim 的方向前进了一大步，所以两者也相对比较接近了。我最近也习惯于使用 NeoVim 了。</p>
<p>vim 和 emacs 之争是一个口味问题，并且我见过的人中基本上只能熟悉其中的一种，没办法同时熟悉两种，这就跟你没法频繁变换两种键位差异巨大的键盘打字一样。功能上两者都非常强，有久经考验的插件生态。在能做的事这块可能 emacs 占优，基本上你在其他很多软件里能获得的功能都可以在一个 emacs 里搞定，比如听歌、上网、写博客等等，谁让它是用只要 7 个函数就能构造出全宇宙的 lisp 写的呢。</p>
<p>好了。以上就是我对终端的简单热爱，其中 90% 是对 vim 的热爱。</p>
<p>为了改善我们的 coding 生活，同时号召那些没有在终端里生活习惯的人尝试这样一种新的方式，我谈一谈如何美化终端里的生活。</p>
<h3 id="终端选择"><a href="#终端选择" class="headerlink" title="终端选择"></a>终端选择</h3><p>我们这里所说的“终端”不是原始的那个终端，而是终端模拟器软件，在这个的选择上我倾向于选择 iTerm2（对了，我现在是忠实的 Mac 用户），在真彩色方面有优势，其他特性在这里我不多展开。</p>
<h3 id="终端配色"><a href="#终端配色" class="headerlink" title="终端配色"></a>终端配色</h3><p>终端的主题配色我推荐 <a href="https://github.com/faywong/codingpack/tree/master/itermcolors" target="_blank" rel="external">base 16</a>，个人很喜欢 base16-3024。</p>
<h3 id="程序员字体"><a href="#程序员字体" class="headerlink" title="程序员字体"></a>程序员字体</h3><p>程序员编程字体我推荐 <code>INCONSOLATA</code>，在过去我使用过微软雅黑 consolas hybrid，source code pro 等那个时代不错的程序员字体。</p>
<h3 id="vim-插件管理器"><a href="#vim-插件管理器" class="headerlink" title="vim 插件管理器"></a>vim 插件管理器</h3><p>NeoVim 插件这块我选择了 vim-plug，整个的 NeoVim 配置文件可从我的 <a href="https://github.com/faywong/codingpack/tree/master/nvim_config/" target="_blank" rel="external">coding pack 仓库</a>下载</p>
<h3 id="vim-插件"><a href="#vim-插件" class="headerlink" title="vim 插件"></a>vim 插件</h3><p>我常用以下几个经典插件：</p>
<ul>
<li>cscope/ctags (搜索利器) </li>
<li>ctrlp</li>
<li>NERDTree</li>
<li>airline (配合 base16-3024 主题味道更好)</li>
<li>youcompleteme (目前用得不多，接下来打算重点用用）</li>
<li>goyo (markdown 语法高亮)</li>
</ul>
<p>网上关于 vim 插件的文章汗牛充栋，我这里链接一篇适合初学者的——<a href="http://zhranklin.com/blog/%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%8E%B0%E4%BB%A3%E5%8C%96%E7%9A%84vim%E7%BC%96%E8%BE%91%E5%99%A8:%20neovim%20+%20nyaovim%20+%20youcompleteme%20+%20airline" target="_blank" rel="external">打造一个现代化的vim编辑器: neovim + nyaovim + youcompleteme + airline</a>。 </p>
<h3 id="vim-对写作的好处"><a href="#vim-对写作的好处" class="headerlink" title="vim 对写作的好处"></a>vim 对写作的好处</h3><p>由于 vim 里写作不需要去操作鼠标，这样你的双手就尽情在键盘上挥洒（跳转、创建文件、提交代码、切 tag 都可以无缝完成）就好了。可以得到一种沉浸式写作的体验。</p>
<h3 id="图例"><a href="#图例" class="headerlink" title="图例"></a>图例</h3><p>附上几张案发现场图</p>
<p><img src="/uploads/2017-6-3-01.png" alt="001"><br><img src="/uploads/2017-6-3-02.png" alt="002"><br><img src="/uploads/2017-6-3-03.png" alt="003"><br><img src="/uploads/2017-6-3-04.png" alt="004"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-10-12-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-10-12-first/" itemprop="url">ndk-gdb时提示应用不可调试的解决方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-10-12-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-10-12-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在开发包含c/c++本地代码的android项目中，通过gdb来调试代码是必不可少的前提。</p>
<p>android官方为此提供了ndk-gdb，看起来非常之nice。但个人在实践中发现还是有一系列问题需要记载下(ndk版本：r10e)：</p>
<p>1) ndk-build NDK_DEBUG=1这个选项编译时要加上，一般将之定制在你的c/c++ builder中</p>
<p>2) 即便你按照1）做了，在项目根目录运行ndk-gdb的时候还是会报以下错误：</p>
<p>ERROR: Package faywong.github.io.mediakit is not debuggable ! You can fix that in two ways:</p>
<ul>
<li><p>Rebuilt with the NDK_DEBUG=1 option when calling ‘ndk-build’.</p>
</li>
<li><p>Modify your manifest to set android:debuggable attribute to “true”,</p>
<p>then rebuild normally.</p>
</li>
</ul>
<p>After one of these, re-install to the device!</p>
<p>然后我们乖乖地跑到AndroidManifest.xml里边去修改Application标签的debuggable属性，eclipse会提示你不能hardcode，可以通过如下方式设置下：</p>
<p>QQ20151012-1</p>
<p>3)  接下来还有可能会遇到如下问题：</p>
<p>ERROR: Could not find gdb.setup under ./libs/</p>
<p>这是由于ndk-gdb命令的bug带来的，它没有去参照ABI的不同设置去不同的目录下找gdb.setup文件（是一个脚本文件，帮你做一些繁琐的gdb server的启动，gdb client的启动和设置等任务）。</p>
<p>简单绕过这个错误的方式是将libs/{your abi, e.g. armeabi-v7a}里的gdb.setup直接拷贝至libs目录下</p>
<p>4)  在你跋山涉水，翻山越岭走了这么久之后，再次运行ndk-gdb，会出现以下惊喜：</p>
<p>ERROR: Non-debuggable application installed on the target device.</p>
<pre><code>Please re-install the debuggable version!
</code></pre><h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><p>现在可以结合gradle-experimental插件和ndk中搭载的lldb + android studio 2.0断点native代码了，虽然还不那么完善，bug多多，但是相比过去的ndk-gdb时代还是进步一点了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-15-second/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-15-second/" itemprop="url">调用WebView中onPause方法需要好好权衡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-15-second/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-15-second/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近踩了一个坑，有个非全屏的dialog遮住我的WebApp容器时，WebApp容器中JS代码操纵dom对象显示文本（input框中）巨慢（俗话描述就是“软键盘中输入了字，但是上屏很慢”）。</p>
<p>debug了一天之后发现。在WebView的onPause方法调用后，其内部JS引擎执行JS代码会慢好几倍。所以是否需要跟随Activity的生命周期调用onPause方法需要根据应用场景来区分：</p>
<p>若是应用中严格依赖JS做一些比较紧要的事情，则不应该onPause WebView。否则应该onPause WebView以释放一部分系统资源。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-15-third/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-15-third/" itemprop="url">三星GS4(android 4.3)上webview crash问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-15-third/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-15-third/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近发现客户端中android4.3上GS4手机上的WebApp应用特别容易crash。分析了源代码之后发现，在ActivityThread中回收内存时会调用EGLImpl里边去，回收RenderThread，进而调用到计算CPU FPS的逻辑，进而crash：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">java.lang.Error: signal 11 (Address not mapped to object) at address 0xbe59dff0 [at libPowerStretch.so:0x2d4c (_ZN11LucidConfig13calcTargetFPSEi+0x1b)]</div><div class="line"></div><div class="line">at system.lib.libPowerStretch_so.0x2d4c(LucidConfig::calcTargetFPS(int):0x1b:0)</div><div class="line"></div><div class="line">at system.lib.libPowerStretch_so.0x2f23(LucidConfig::isLucidActive(bool):0x86:0)</div></pre></td></tr></table></figure>
<p>因为在问题出在系统层而android应用回收内存这个message是ActivityManager发出，为正常且必要的行为，无法规避。最终选择如下方式将其绕过：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">H5WebViewRenderPolicy</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldDisableHardwareRenderInLayer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// case 1: samsung GS4 on android 4.3 is know to cause crashes at libPowerStretch.so:0x2d4c</span></div><div class="line">        <span class="comment">// use GT-I95xx to match more GS4 series devices though GT-I9500 is the typical device</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSamsungGs4 = android.os.Build.MODEL != <span class="keyword">null</span> &amp;&amp; android.os.Build.MODEL.contains(<span class="string">"GT-I95"</span>) &amp;&amp; android.os.Build.MANUFACTURER != <span class="keyword">null</span> &amp;&amp; android.os.Build.MANUFACTURER.equals(<span class="string">"samsung"</span>);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isJbMr2 = Build.VERSION.SDK_INT == Build.VERSION_CODES.JELLY_BEAN_MR2;</div><div class="line">        <span class="keyword">if</span> (isSamsungGs4 &amp;&amp; isJbMr2) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上定义一个渲染策略类（方便以后维护），针对GS4 + android 4.3这种组合在WebView layer层面关闭硬件加速（这样就不会存在RenderThread，自然也就没法触发上文的crash）。</p>
<p>之后在自定义WebView中利用上以上渲染策略类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> meetApiLevel11 = Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB;</div><div class="line"><span class="keyword">if</span> (H5WebViewRenderPolicy.shouldDisableHardwareRenderInLayer() &amp;&amp; meetApiLevel11) &#123;</div><div class="line">    <span class="keyword">final</span> View underlyingWebView = webView.getUnderlyingWebView();</div><div class="line">    <span class="keyword">if</span> (underlyingWebView != <span class="keyword">null</span> &amp;&amp; webView.getType().equals(WebViewType.SYSTEM_BUILD_IN)) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            underlyingWebView.setLayerType(View.LAYER_TYPE_SOFTWARE, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception globalException) &#123;</div><div class="line">            globalException.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="更新-2015-2-1"><a href="#更新-2015-2-1" class="headerlink" title="更新 2015/2/1"></a>更新 2015/2/1</h2><p>该现象表现在多款三星制造的搭载android 4.3系统的手机上，不仅限于GS4</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-16-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-16-first/" itemprop="url">WebView getUserAgentString的副作用分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-16-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-16-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>源代码如下(以android 4.0.4为例)：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">getUserAgentString</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (DESKTOP_USERAGENT.equals(mUserAgent) ||</div><div class="line">        IPHONE_USERAGENT.equals(mUserAgent) ||</div><div class="line">        !mUseDefaultUserAgent) &#123;</div><div class="line">        <span class="keyword">return</span> mUserAgent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> doPostSync = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">synchronized</span>(sLockForLocaleSettings) &#123;</div><div class="line">        Locale currentLocale = Locale.getDefault();</div><div class="line">        <span class="keyword">if</span> (!sLocale.equals(currentLocale)) &#123;</div><div class="line">            sLocale = currentLocale;</div><div class="line">            mUserAgent = getCurrentUserAgent();</div><div class="line">            mAcceptLanguage = getCurrentAcceptLanguage();</div><div class="line">            doPostSync = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (doPostSync) &#123;</div><div class="line">        postSync();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mUserAgent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中后半段代码用于将当前locale设定同步到生成的UA中。所以该方法是有副作用的。</p>
<p>在一个使用了WebView的Activity里实例化完成和系统Configuration改变后都需要调用一次getUserAgentString()来让WebView的UA（前提是不要设置自己的UA，即没有针对此WebView调用过setUserAgentString）中locale分量与系统的设定保持一致。以免在访问多语言网站时出现适配问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-19-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-19-first/" itemprop="url">android4.1上WebView页面加载成功时出现IllegalArgumentException</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-19-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-19-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>异常的堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">java.lang.IllegalArgumentException: bad parameter</div><div class="line">   at org.apache.http.client.utils.URLEncodedUtils.parse(URLEncodedUtils.java:<span class="number">139</span>)</div><div class="line">   at org.apache.http.client.utils.URLEncodedUtils.parse(URLEncodedUtils.java:<span class="number">76</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.getAxsUrlParameterValue(AccessibilityInjector.java:<span class="number">412</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.shouldInjectJavaScript(AccessibilityInjector.java:<span class="number">327</span>)</div><div class="line">   at android.webkit.AccessibilityInjector.onPageFinished(AccessibilityInjector.java:<span class="number">286</span>)</div><div class="line">   at android.webkit.WebViewClassic.onPageFinished(WebViewClassic.java:<span class="number">4088</span>)</div><div class="line">   at android.webkit.CallbackProxy.handleMessage(CallbackProxy.java:<span class="number">332</span>)</div><div class="line">   at android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>)</div><div class="line">   at android.os.Looper.loop(Looper.java:<span class="number">137</span>)</div><div class="line">   at android.app.ActivityThread.main(ActivityThread.java:<span class="number">4829</span>)</div><div class="line">   at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">   at java.lang.reflect.Method.invoke(Method.java:<span class="number">511</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">841</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">608</span>)</div><div class="line">   at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure>
<p>相关的google code android project里边的issue中论述如下：</p>
<p>“<br>A customer of mine running 4.1.2 just informed me that the issue is still<br>present! After this issue crashes my app, I have to pop up a dialog<br>telling them to disable all accessibility services.<br>Worst user experience ever, but what else can I do.<br>……<br>Fixed in an internal build, to be released in the next major release.<br>……<br>The bug doesn’t occur here in 4.2.1 (Galaxy Nexus, JOP40D).<br>“</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-20-second/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-20-second/" itemprop="url">开源的崩溃统计项目Socorro</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-20-second/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-20-second/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由Mozilla开源的崩溃统计项目Socorro非常适合针对客户端的崩溃闪退、日志/堆栈上报，服务端进行采集、处理、分析、报告。</p>
<p>客户端的工作由类库<a href="https://wiki.mozilla.org/Breakpad" target="_blank" rel="external">Breakpad</a>完成。</p>
<p>服务端的工作由<a href="https://github.com/mozilla/socorro/" target="_blank" rel="external">Socorro</a>完成。</p>
<p>代码托管在<a href="https://github.com/mozilla/socorro" target="_blank" rel="external">github</a>.</p>
<p>看这个提交和发布的数目，迭代程度还是挺深的。</p>
<p>这样针对移动开发，就不必重复造轮子了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-21-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-21-first/" itemprop="url">通过PackageManager query应用信息时出现java.lang.RuntimeException: Package manager has died</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-21-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-21-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这属于android中最常见的TransactionTooLargeException的后果表现之一。</p>
<p>该问题较多出现在使用PackageManager查询系统的应用的信息，通过Intent来过滤匹配目标应用组件（android四大组件）时，典型堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">java.lang.RuntimeException: Package manager has died</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">78</span>)</div><div class="line"></div><div class="line">......</div><div class="line">Caused by: android.os.TransactionTooLargeException</div><div class="line">at android.os.BinderProxy.transact(Native Method)</div><div class="line">at android.content.pm.IPackageManager$Stub$Proxy.getPackageInfo(IPackageManager.java:<span class="number">1393</span>)</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">73</span>)</div><div class="line">... <span class="number">17</span> more</div><div class="line">android.os.TransactionTooLargeException</div><div class="line">at android.os.BinderProxy.transact(Native Method)</div><div class="line">at android.content.pm.IPackageManager$Stub$Proxy.getPackageInfo(IPackageManager.java:<span class="number">1393</span>)</div><div class="line">at android.app.ApplicationPackageManager.getPackageInfo(ApplicationPackageManager.java:<span class="number">73</span>)</div></pre></td></tr></table></figure>
<p>这是Java层的堆栈，原始抛出异常的地方在于文件frameworks/base/core/jni/android_util_Binder.cpp：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">case</span> FAILED_TRANSACTION:</div><div class="line"> LOGE(<span class="string">"!!! FAILED BINDER TRANSACTION !!!"</span>);</div><div class="line"> <span class="comment">// TransactionTooLargeException is a checked exception, only throw from certain methods.</span></div><div class="line"> <span class="comment">// <span class="doctag">FIXME:</span> Transaction too large is the most common reason for FAILED_TRANSACTION</span></div><div class="line"> <span class="comment">//        but it is not the only one.  The Binder driver can return BR_FAILED_REPLY</span></div><div class="line"> <span class="comment">//        for other reasons also, such as if the transaction is malformed or</span></div><div class="line"> <span class="comment">//        refers to an FD that has been closed.  We should change the driver</span></div><div class="line"> <span class="comment">//        to enable us to distinguish these cases in the future.</span></div><div class="line"> jniThrowException(env, canThrowRemoteException</div><div class="line"> ? <span class="string">"android/os/TransactionTooLargeException"</span></div><div class="line"> : <span class="string">"java/lang/RuntimeException"</span>, <span class="literal">NULL</span>);</div><div class="line"> <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>该FAILED_TRANSACTION错误码定义于：<br>/bionic/libc/kernel/common/linux/binder.h中的BR_FAILED_REPLY</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">enum</span> BinderDriverReturnProtocol &#123;</div><div class="line">BR_ERROR = _IOR_BAD(<span class="string">'r'</span>, <span class="number">0</span>, <span class="keyword">int</span>),</div><div class="line"></div><div class="line">BR_OK = _IO(<span class="string">'r'</span>, <span class="number">1</span>),</div><div class="line"></div><div class="line">BR_TRANSACTION = _IOR_BAD(<span class="string">'r'</span>, <span class="number">2</span>, struct binder_transaction_data),</div><div class="line">BR_REPLY = _IOR_BAD(<span class="string">'r'</span>, <span class="number">3</span>, struct binder_transaction_data),</div><div class="line"></div><div class="line">BR_ACQUIRE_RESULT = _IOR_BAD(<span class="string">'r'</span>, <span class="number">4</span>, <span class="keyword">int</span>),</div><div class="line"></div><div class="line">BR_DEAD_REPLY = _IO(<span class="string">'r'</span>, <span class="number">5</span>),</div><div class="line"></div><div class="line">BR_TRANSACTION_COMPLETE = _IO(<span class="string">'r'</span>, <span class="number">6</span>),</div><div class="line"></div><div class="line">BR_INCREFS = _IOR_BAD(<span class="string">'r'</span>, <span class="number">7</span>, struct binder_ptr_cookie),</div><div class="line">BR_ACQUIRE = _IOR_BAD(<span class="string">'r'</span>, <span class="number">8</span>, struct binder_ptr_cookie),</div><div class="line">BR_RELEASE = _IOR_BAD(<span class="string">'r'</span>, <span class="number">9</span>, struct binder_ptr_cookie),</div><div class="line">BR_DECREFS = _IOR_BAD(<span class="string">'r'</span>, <span class="number">10</span>, struct binder_ptr_cookie),</div><div class="line"></div><div class="line">BR_ATTEMPT_ACQUIRE = _IOR_BAD(<span class="string">'r'</span>, <span class="number">11</span>, struct binder_pri_ptr_cookie),</div><div class="line"></div><div class="line">BR_NOOP = _IO(<span class="string">'r'</span>, <span class="number">12</span>),</div><div class="line"></div><div class="line">BR_SPAWN_LOOPER = _IO(<span class="string">'r'</span>, <span class="number">13</span>),</div><div class="line"></div><div class="line">BR_FINISHED = _IO(<span class="string">'r'</span>, <span class="number">14</span>),</div><div class="line"></div><div class="line">BR_DEAD_BINDER = _IOR_BAD(<span class="string">'r'</span>, <span class="number">15</span>, <span class="keyword">void</span> *),</div><div class="line"></div><div class="line">BR_CLEAR_DEATH_NOTIFICATION_DONE = _IOR_BAD(<span class="string">'r'</span>, <span class="number">16</span>, <span class="keyword">void</span> *),</div><div class="line"></div><div class="line">BR_FAILED_REPLY = _IO(<span class="string">'r'</span>, <span class="number">17</span>),</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其原因总结如下，首先Android系统对于Binder IPC每进程的事务buffer上限是1M（为所有Binder事务共享，且不区分目标系统的ram配置等因素），在通过PackageManager中获取系统内应用时，比如应用的Icon是个bitmap，且不同应用所制作Icon的品质（像素数）上差异很大。会占用大量内存导致Binder事务内存超过上限。</p>
<p>Binder事务buffer的尺寸定义在ProcessState.cpp：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BINDER_VM_SIZE((1 * 1024 * 1024) - (4096 * 2))</span></div><div class="line">......</div><div class="line">ProcessState::ProcessState(): mDriverFD(open_driver()), mVMStart(MAP_FAILED), mManagesContexts(<span class="literal">false</span>), mBinderContextCheckFunc(<span class="literal">NULL</span>), mBinderContextUserData(<span class="literal">NULL</span>), mThreadPoolStarted(<span class="literal">false</span>), mThreadPoolSeq(<span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// XXX Ideally, there should be a specific define for whether we</span></div><div class="line">        <span class="comment">// have mmap (or whether we could possibly have the kernel module</span></div><div class="line">        <span class="comment">// availabla).</span></div><div class="line">        <span class="meta">#</span></div><div class="line">        <span class="meta-keyword">if</span> !defined(HAVE_WIN32_IPC)</div><div class="line">            <span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></div><div class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (mVMStart == MAP_FAILED) &#123;</div><div class="line">            <span class="comment">// *sigh*</span></div><div class="line">            LOGE(<span class="string">"Using /dev/binder failed: unable to mmap transaction memory.\n"</span>);</div><div class="line">            close(mDriverFD);</div><div class="line">            mDriverFD = <span class="number">-1</span>;</div><div class="line">        &#125;<span class="meta">#</span></div><div class="line">        <span class="meta-keyword">else</span></div><div class="line">            mDriverFD = <span class="number">-1</span>;<span class="meta">#</span></div><div class="line">        <span class="meta-keyword">endif</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    LOG_ALWAYS_FATAL_IF(mDriverFD &lt; <span class="number">0</span>, <span class="string">"Binder driver could not be opened.  Terminating."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>App icon对应的数据模型如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppInfo</span> </span>&#123;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">private</span> BitmapDrawable icon</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该问题是android系统的限制，只能通过上层来捕获该异常来绕过。当然也不仅限于PackageManager，其他系统服务，应用间的Binder调用也可以带来这一问题。</p>
<p>最后的最后，由于在c++向java层抛出这个异常的场景有多种（见上边c++代码中“FAILED_TRANSACTION”处的注释），所以当你收到了TransactionTooLargeException的时候，不意味着真正的Transaction is Too Large。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-01-23-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-01-23-first/" itemprop="url">应用压入后台时由WebView带来的耗电问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-01-23-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-01-23-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近遇到一个应用打开WebApp后，将应用压入后台，出现比较耗电的问题。集合众多同学的智慧之后定位到原因：</p>
<p>在WebKit的内核中会引用从各个平台(android, linux pc, mac)注入的自己的服务比如：</p>
<ul>
<li>DeviceOrientationService</li>
<li>DeviceMotionService</li>
</ul>
<p>而这两个Service在android平台上的实现皆通过注册侦听器到SensorManager来获知来自于加速度器，磁力计的方位、手机姿势数据。</p>
<p>Sensor的使用是极其浪费电力的一件事情，所以就出现了上文所述问题。</p>
<p>解决方法：</p>
<p>1) 在Activity的onPause(), onResume()时调用WebView.onPause(), WebView.onResume()以尽量将JS执行线程以及其他WebCore中的线程给停住</p>
<p>2) 在onStop()时将WebView中当前load的url记住，然后让WebView.loadUrl(“about:blank”)，在onStart()时WebView.loadUrl({your_previous_url})</p>
<p>更新：<br>[2015/11]在最近的工作中还发现一种前端页面带来的耗电问题：当页面加载一些gif或者通过其他方式创建的动画效果，当webview变得不可见后这些动画如果没有被显式关掉，就会导致很严重的耗电问题。同时在桌面浏览器里边我也注意到页面里边持续运行的动画也会导致内存占用增大。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://faywong.github.io/2017/06/03/2015-02-01-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="faywong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog of faywong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/03/2015-02-01-first/" itemprop="url">android库ShowcaseView</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T12:16:31+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/03/2015-02-01-first/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/03/2015-02-01-first/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一个非常适合用于对用户进行第一次使用进行指导的库ShowcaseView，截图示例如下：</p>
<p><img src="/uploads/2015-02-01-01.png" alt="showcase view 1"></p>
<p><img src="/uploads/2015-02-01-02.png" alt="showcase view 2"></p>
<p>下面给出一个实例，需要瞄定一个特殊的View(id为R.id.answers)，在其上显示一个ShowCaseView：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">new</span> ShowcaseView.Builder(getActivity()).setTarget(<span class="keyword">new</span> ActionItemTarget(getActivity(), R.id.answers)) </div><div class="line"><span class="comment">//Here is where you supply the id of the action bar item you want to display </span></div><div class="line">.setContentTitle(<span class="string">"Title"</span>).setContentText(<span class="string">"Description"</span>).hideOnTouchOutside().build();</div></pre></td></tr></table></figure>
<p>项目主页位于：<a href="https://github.com/amlcurran/ShowcaseView，从其commit数和release数来看，应该非常靠谱。" target="_blank" rel="external">https://github.com/amlcurran/ShowcaseView，从其commit数和release数来看，应该非常靠谱。</a></p>
<p>接下来打算在项目中使用起来，后续补上使用感受。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="faywong" />
          <p class="site-author-name" itemprop="name">faywong</p>
           
              <p class="site-description motion-element" itemprop="description">blog of faywong, faywong</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">faywong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"faywong"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  





  

  

  

  

  

  

</body>
</html>
