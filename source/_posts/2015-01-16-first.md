title: "WebView getUserAgentString的副作用分析"
tags:  ["android", "webview"]
---

源代码如下(以android 4.0.4为例)：

```java
public synchronized String getUserAgentString() {
    if (DESKTOP_USERAGENT.equals(mUserAgent) ||
        IPHONE_USERAGENT.equals(mUserAgent) ||
        !mUseDefaultUserAgent) {
        return mUserAgent;
    }

    boolean doPostSync = false;
    synchronized(sLockForLocaleSettings) {
        Locale currentLocale = Locale.getDefault();
        if (!sLocale.equals(currentLocale)) {
            sLocale = currentLocale;
            mUserAgent = getCurrentUserAgent();
            mAcceptLanguage = getCurrentAcceptLanguage();
            doPostSync = true;
        }
    }
    if (doPostSync) {
        postSync();
    }
    return mUserAgent;
}
```
其中后半段代码用于将当前locale设定同步到生成的UA中。所以该方法是有副作用的。

在一个使用了WebView的Activity里实例化完成和系统Configuration改变后都需要调用一次getUserAgentString()来让WebView的UA（前提是不要设置自己的UA，即没有针对此WebView调用过setUserAgentString）中locale分量与系统的设定保持一致。以免在访问多语言网站时出现适配问题。