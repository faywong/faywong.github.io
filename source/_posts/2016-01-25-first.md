title: "android开发中ConditionVariable的典型用法"
tags: ["android"]
---

尽管现在诞生的高级语言里边有了什么STM，协程，绿程的概念，但写代码总会遇到现实（商业级平台都不会用很新的东西）的多线程的问题。

比如有时候你需要同步的获取在另一个线程执行的代码的结果，在android里这种场景下ConditionVariable就非常好用了。

```java
if (Looper.myLooper() != Looper.getMainLooper()) {

    final ConditionVariable completed = new ConditionVariable(); // 构造一个条件变量

    view.runOnUiThread(new Runnable() {

        @Override
        public void run() {
            try {
                doSomeThingInUiThread(); // 将期望在另外线程做的事post出去
            } finally { // finally很重要，防止运行时异常远跳转将ConditionVariable忘了open
                completed.open(); // 事情办完了，notify到另外线程
            }
        }
    });
    completed.block(TIMEOUT_WAIT_UI); // 等着另外线程做的事完成，同时支持设置超时
} else {
    doSomeThingInUiThread();
}
```

当然了以上是很简单的一个场景，使用ConditionVariable非常方便且够用。对于复杂的多线程之间的协同还是使用标准的条件变量结合lock + while 循环检查。

在一些新语言中有非常丰富的并发编程原语（future, delay, promise），特别是协程让我们用代码自主的确定代码流之间的协作关系而不是被动的作为OS调度器的奴隶，来支撑一些并行需求。